"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.bulkUpdateSubaccountFields = exports.bulkCreate = exports.getOpenInterestLong = exports.closePositionUpdateObject = exports.closePosition = exports.findOpenPositionsForSubaccounts = exports.findOpenPositionForSubaccountPerpetual = exports.findById = exports.update = exports.create = exports.findAll = exports.uuid = void 0;
const lodash_1 = __importDefault(require("lodash"));
const constants_1 = require("../constants");
const error_helpers_1 = require("../helpers/error-helpers");
const knex_1 = require("../helpers/knex");
const stores_helpers_1 = require("../helpers/stores-helpers");
const transaction_1 = __importDefault(require("../helpers/transaction"));
const uuid_1 = require("../helpers/uuid");
const perpetual_position_model_1 = __importDefault(require("../models/perpetual-position-model"));
const types_1 = require("../types");
const DEFAULT_CREATE_FIELDS = {
    sumOpen: '0',
    sumClose: '0',
    entryPrice: '0',
};
const DEFAULT_SUBACCOUNT_UPDATE_DEFAULT_POSITION_FIELDS = {
    closedAt: null,
    closedAtHeight: null,
    closeEventId: null,
};
function uuid(subaccountId, openEventId) {
    // TODO(IND-483): Fix all uuid string substitutions to use Array.join.
    return (0, uuid_1.getUuid)(Buffer.from(`${subaccountId}-${openEventId.toString('hex')}`, constants_1.BUFFER_ENCODING_UTF_8));
}
exports.uuid = uuid;
async function findAll({ id, subaccountId, perpetualId, side, status, createdBeforeOrAtHeight, createdBeforeOrAt, limit, }, requiredFields, options = constants_1.DEFAULT_POSTGRES_OPTIONS) {
    (0, stores_helpers_1.verifyAllRequiredFields)({
        id,
        subaccountId,
        perpetualId,
        side,
        status,
        limit,
    }, requiredFields);
    let baseQuery = (0, stores_helpers_1.setupBaseQuery)(perpetual_position_model_1.default, options);
    if (id !== undefined) {
        baseQuery = baseQuery.whereIn(types_1.PerpetualPositionColumns.id, id);
    }
    if (subaccountId !== undefined) {
        baseQuery = baseQuery.whereIn(types_1.PerpetualPositionColumns.subaccountId, subaccountId);
    }
    if (perpetualId !== undefined) {
        baseQuery = baseQuery.whereIn(types_1.PerpetualPositionColumns.perpetualId, perpetualId);
    }
    if (side !== undefined) {
        baseQuery = baseQuery.where(types_1.PerpetualPositionColumns.side, side);
    }
    if (status !== undefined) {
        baseQuery = baseQuery.whereIn(types_1.PerpetualPositionColumns.status, status);
    }
    if (createdBeforeOrAtHeight !== undefined) {
        baseQuery = baseQuery.where(types_1.PerpetualPositionColumns.createdAtHeight, '<=', createdBeforeOrAtHeight);
    }
    if (createdBeforeOrAt !== undefined) {
        baseQuery = baseQuery.where(types_1.PerpetualPositionColumns.createdAt, '<=', createdBeforeOrAt);
    }
    if (options.orderBy !== undefined) {
        for (const [column, order] of options.orderBy) {
            baseQuery = baseQuery.orderBy(column, order);
        }
    }
    else {
        baseQuery = baseQuery.orderBy(types_1.PerpetualPositionColumns.subaccountId, types_1.Ordering.ASC).orderBy(types_1.PerpetualPositionColumns.openEventId, types_1.Ordering.DESC);
    }
    if (limit) {
        baseQuery = baseQuery.limit(limit);
    }
    return baseQuery.returning('*');
}
exports.findAll = findAll;
async function create(perpetualPosition, options = { txId: undefined }) {
    const perpetualPositionToCreate = {
        ...DEFAULT_CREATE_FIELDS,
        ...perpetualPosition,
    };
    return perpetual_position_model_1.default.query(transaction_1.default.get(options.txId)).insert({
        id: uuid(perpetualPositionToCreate.subaccountId, perpetualPositionToCreate.openEventId),
        ...perpetualPositionToCreate,
    }).returning('*');
}
exports.create = create;
async function update({ id, ...fields }, options = { txId: undefined }) {
    const perpetualPosition = await perpetual_position_model_1.default.query(transaction_1.default.get(options.txId)).findById(id).patch(fields).returning('*');
    // The objection types mistakenly think the query returns an array of perpetual positions.
    return perpetualPosition;
}
exports.update = update;
async function findById(id, options = constants_1.DEFAULT_POSTGRES_OPTIONS) {
    const baseQuery = (0, stores_helpers_1.setupBaseQuery)(perpetual_position_model_1.default, options);
    return baseQuery
        .findById(id)
        .returning('*');
}
exports.findById = findById;
async function findOpenPositionForSubaccountPerpetual(subaccountId, perpetualId, options = constants_1.DEFAULT_POSTGRES_OPTIONS) {
    const positions = await findAll({
        subaccountId: [subaccountId],
        perpetualId: [perpetualId],
        status: [types_1.PerpetualPositionStatus.OPEN],
    }, [], options);
    if (positions.length === 0) {
        return undefined;
    }
    return positions[0];
}
exports.findOpenPositionForSubaccountPerpetual = findOpenPositionForSubaccountPerpetual;
async function findOpenPositionsForSubaccounts(subaccountIds, options = constants_1.DEFAULT_POSTGRES_OPTIONS) {
    const positions = await findAll({
        subaccountId: subaccountIds,
        status: [types_1.PerpetualPositionStatus.OPEN],
    }, [], options);
    if (positions.length === 0) {
        return {};
    }
    return lodash_1.default.reduce(positions, (acc, position) => {
        const { subaccountId, perpetualId } = position;
        acc[subaccountId] = acc[subaccountId] || {};
        acc[subaccountId][perpetualId] = position;
        return acc;
    }, {});
}
exports.findOpenPositionsForSubaccounts = findOpenPositionsForSubaccounts;
async function closePosition(existingPosition, perpetualPositionCloseObject, options = { txId: undefined }) {
    const updateObject = closePositionUpdateObject(existingPosition, perpetualPositionCloseObject);
    return update(updateObject, options);
}
exports.closePosition = closePosition;
/**
 * Validates close position and returns the update object to update the position.
 */
function closePositionUpdateObject(existingPosition, perpetualPositionCloseObject) {
    validateClosePosition(existingPosition);
    return {
        id: perpetualPositionCloseObject.id,
        closedAt: perpetualPositionCloseObject.closedAt,
        closedAtHeight: perpetualPositionCloseObject.closedAtHeight,
        closeEventId: perpetualPositionCloseObject.closeEventId,
        lastEventId: perpetualPositionCloseObject.closeEventId,
        settledFunding: perpetualPositionCloseObject.settledFunding,
        status: types_1.PerpetualPositionStatus.CLOSED,
        size: '0',
    };
}
exports.closePositionUpdateObject = closePositionUpdateObject;
/**
 * Throws an error if the position to close is already closed.
 * @param existingPosition
 */
function validateClosePosition(existingPosition) {
    if (existingPosition.status === types_1.PerpetualPositionStatus.CLOSED) {
        (0, error_helpers_1.logAndThrowValidationError)('Unable to close because position is closed');
    }
}
// TODO(DEC-1821): Fix getOpenInterestLong to only return data for the ids requested
async function getOpenInterestLong(perpetualMarketIds) {
    if (perpetualMarketIds.length === 0) {
        return {};
    }
    const perpetualMarketIdsSqlArray = `(${perpetualMarketIds.join(',')})`;
    const result = await knex_1.knexReadReplica.getConnection().raw(`SELECT
      "perpetualId" AS "perpetualMarketId",
      sum(size) AS "openInterest"
    FROM perpetual_positions
    WHERE "side"='LONG'
      AND "status"='OPEN'
      AND "perpetualId" IN ${perpetualMarketIdsSqlArray}
    GROUP BY "perpetualId";
    `);
    const openInterestStats = lodash_1.default.keyBy(result.rows, 'perpetualMarketId');
    Object.values(perpetualMarketIds).forEach((perpetualMarketId) => {
        if (!openInterestStats[perpetualMarketId]) {
            // no positions exist for this market, set to 0
            openInterestStats[perpetualMarketId] = {
                perpetualMarketId,
                openInterest: '0',
            };
        }
    });
    return openInterestStats;
}
exports.getOpenInterestLong = getOpenInterestLong;
async function bulkCreate(positions, options = { txId: undefined }) {
    const perpetualPositionsToCreate = lodash_1.default.map(positions, (position) => {
        return {
            ...DEFAULT_CREATE_FIELDS,
            ...position,
        };
    });
    return perpetual_position_model_1.default.query(transaction_1.default.get(options.txId)).insert(perpetualPositionsToCreate.map((position) => ({
        id: uuid(position.subaccountId, position.openEventId),
        ...position,
    }))).returning('*');
}
exports.bulkCreate = bulkCreate;
/**
 * Bulk update for processing SubaccountUpdateEvents. Updates the following fields:
 * - closedAt
 * - closedAtHeight
 * - closeEventId
 * - lastEventId
 * - settledFunding
 * - status
 * - size
 * - maxSize
 * maxSize is calculated algorithmically based on the previous maxSize and the new size.
 */
async function bulkUpdateSubaccountFields(positions, options = { txId: undefined }) {
    if (positions.length === 0) {
        return;
    }
    const positionUpdatesWithDefaultValues = lodash_1.default.map(positions, (position) => {
        return {
            ...DEFAULT_SUBACCOUNT_UPDATE_DEFAULT_POSITION_FIELDS,
            ...position,
            [types_1.PerpetualPositionColumns.perpetualId]: undefined,
        };
    });
    positionUpdatesWithDefaultValues.forEach((position) => (0, stores_helpers_1.verifyAllInjectableVariables)(Object.values(position)));
    const columns = [
        types_1.PerpetualPositionColumns.id,
        types_1.PerpetualPositionColumns.closedAt,
        types_1.PerpetualPositionColumns.closedAtHeight,
        types_1.PerpetualPositionColumns.closeEventId,
        types_1.PerpetualPositionColumns.lastEventId,
        types_1.PerpetualPositionColumns.settledFunding,
        types_1.PerpetualPositionColumns.status,
        types_1.PerpetualPositionColumns.size,
    ];
    const positionRows = (0, stores_helpers_1.setBulkRowsForUpdate)({
        objectArray: positionUpdatesWithDefaultValues,
        columns,
        stringColumns: [
            types_1.PerpetualPositionColumns.id,
            types_1.PerpetualPositionColumns.status,
        ],
        numericColumns: [
            types_1.PerpetualPositionColumns.settledFunding,
            types_1.PerpetualPositionColumns.size,
        ],
        bigintColumns: [
            types_1.PerpetualPositionColumns.closedAtHeight,
        ],
        timestampColumns: [
            types_1.PerpetualPositionColumns.closedAt,
        ],
        binaryColumns: [
            types_1.PerpetualPositionColumns.closeEventId,
            types_1.PerpetualPositionColumns.lastEventId,
        ],
    });
    const query = (0, stores_helpers_1.generateBulkUpdateString)({
        table: perpetual_position_model_1.default.tableName,
        objectRows: positionRows,
        columns,
        isUuid: true,
        uniqueIdentifier: types_1.PerpetualPositionColumns.id,
        setFieldsToAppend: [
            `"${types_1.PerpetualPositionColumns.maxSize}" = GREATEST("${types_1.PerpetualPositionColumns.maxSize}", c."${types_1.PerpetualPositionColumns.size}")`,
        ],
    });
    const transaction = transaction_1.default.get(options.txId);
    return transaction
        ? knex_1.knexPrimary.raw(query).transacting(transaction)
        : knex_1.knexPrimary.raw(query);
}
exports.bulkUpdateSubaccountFields = bulkUpdateSubaccountFields;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVycGV0dWFsLXBvc2l0aW9uLXRhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3N0b3Jlcy9wZXJwZXR1YWwtcG9zaXRpb24tdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0Esb0RBQXVCO0FBR3ZCLDRDQUErRTtBQUMvRSw0REFBc0U7QUFDdEUsMENBQStEO0FBQy9ELDhEQU1tQztBQUNuQyx5RUFBaUQ7QUFDakQsMENBQTBDO0FBQzFDLGtHQUF3RTtBQUN4RSxvQ0Fla0I7QUFFbEIsTUFBTSxxQkFBcUIsR0FBRztJQUM1QixPQUFPLEVBQUUsR0FBRztJQUNaLFFBQVEsRUFBRSxHQUFHO0lBQ2IsVUFBVSxFQUFFLEdBQUc7Q0FDaEIsQ0FBQztBQUVGLE1BQU0saURBQWlELEdBQUc7SUFDeEQsUUFBUSxFQUFFLElBQUk7SUFDZCxjQUFjLEVBQUUsSUFBSTtJQUNwQixZQUFZLEVBQUUsSUFBSTtDQUNuQixDQUFDO0FBRUYsU0FBZ0IsSUFBSSxDQUFDLFlBQW9CLEVBQUUsV0FBbUI7SUFDNUQsc0VBQXNFO0lBQ3RFLE9BQU8sSUFBQSxjQUFPLEVBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLFlBQVksSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsaUNBQXFCLENBQUMsQ0FBQyxDQUFDO0FBQ3ZHLENBQUM7QUFIRCxvQkFHQztBQUVNLEtBQUssVUFBVSxPQUFPLENBQzNCLEVBQ0UsRUFBRSxFQUNGLFlBQVksRUFDWixXQUFXLEVBQ1gsSUFBSSxFQUNKLE1BQU0sRUFDTix1QkFBdUIsRUFDdkIsaUJBQWlCLEVBQ2pCLEtBQUssR0FDd0IsRUFDL0IsY0FBZ0MsRUFDaEMsVUFBbUIsb0NBQXdCO0lBRTNDLElBQUEsd0NBQXVCLEVBQ3JCO1FBQ0UsRUFBRTtRQUNGLFlBQVk7UUFDWixXQUFXO1FBQ1gsSUFBSTtRQUNKLE1BQU07UUFDTixLQUFLO0tBQ1MsRUFD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